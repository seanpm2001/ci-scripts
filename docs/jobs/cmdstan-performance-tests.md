## CmdStan Performance Tests

### History

- Master history can be found [here](https://jenkins.mc-stan.org/job/CmdStan%20Performance%20Tests/job/master/)
- Custom history can be found [here](https://jenkins.mc-stan.org/job/CmdStan%20Performance%20Tests/job/Custom/)
- Downstream_tests history can be found [here](https://jenkins.mc-stan.org/job/CmdStan%20Performance%20Tests/job/downstream_tests/)

### Jenkinsfile

Link to Jenkins project: [CmdStan Performance Tests](https://jenkins.mc-stan.org/job/CmdStan%20Performance%20Tests)

Parameters:  

- `cmdstan_pr` - CmdStan PR (Example: PR-123) which will be tested against develop
- `stan_pr` - Stan PR (Example: PR-123)
- `math_pr` - Math PR (Example: PR-123)

Stages:  

1. [Clean checkout](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L145)
   - Checks out master
2. [Gather machine information](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L163)
   - Based on the OS will print various information to the console for it to be later extracted and sent to GitHub as a comment.
   - As follows:
     - `g++ --version`
     - `clang --version`
     - windows
       - `wmic CPU get NAME`
       - `ver`
     - macos
       - `sysctl -n machdep.cpu.brand_string `
       - `sw_vers`
     - linux
       - `lscpu`
       - `lsb_release -a`
3. [Update CmdStan pointer to latest develop](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L208)
4. [Test cmdstan develop against cmdstan pointer in this branch](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L227)
   - Gets the cmdstan branch based on cmdstan_pr parameter using [branchOrPR](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L8)
   - Gets the old cmdstan hash `old_hash=\$(git submodule status | grep cmdstan | awk '{print \$1}')`
   - Gets the new cmdstan hash `cmdstan_hash=\$(if [ -n "${cmdstan_pr}" ]; then echo "${cmdstan_pr}"; else echo "\$old_hash" ; fi)`
   - Executes [compare-git-hashes](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/compare-git-hashes.sh) `bash compare-git-hashes.sh stat_comp_benchmarks develop \$cmdstan_hash ${branchOrPR(params.stan_pr)} ${branchOrPR(params.math_pr)}`
5. [Numerical Accuracy and Performance Tests on Known-Good Models](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L243)
   - When on branch `master`
     - `writeFile(file: "cmdstan/make/local", text: "CXXFLAGS += -march=core2")`
     - `./runPerformanceTests.py --runs 3 --check-golds --name=known_good_perf --tests-file=known_good_perf_all.tests`
6. [Shotgun Performance Regression Tests](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L250)
   - When on branch `master`
     - `make clean`
     - `writeFile(file: "cmdstan/make/local", text: "CXXFLAGS += -march=native")`
     - `cat shotgun_perf_all.tests`
     - `./runPerformanceTests.py --name=shotgun_perf --tests-file=shotgun_perf_all.tests --runs=2`
7. [Collect test results](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L259)
   - When on branch `master`
     - Collects `*.xml` with [JUnit](https://wiki.jenkins.io/display/JENKINS/JUnit+Plugin) for later visuals
     - Archives `*.xml` artifacts for later use and availability in the results page
     - Stores `*.xml` with [perfReport](https://jenkins.io/doc/pipeline/steps/performance/) for later performance comparasion
8. [Post Action](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L281)
   - On Success
        - It will extract the job log
        - Extract the markdown generated by [comparePerformance.py](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/comparePerformance.py#L20)
        - Extract OS informations printed earlier
        - Creates a nice table with all the above data easily readable for the user and [posts](https://github.com/stan-dev/performance-tests-cmdstan/blob/master/Jenkinsfile#L88) it to the github PR page as a comment
   - On Failure
        - Execute [utils.mailBuildResults](https://github.com/stan-dev/jenkins-shared-libraries/blob/master/src/org/stan/Utils.groovy#L51) ("FAILURE") to send a notification email.
   - On Unstable
        - Execute [utils.mailBuildResults](https://github.com/stan-dev/jenkins-shared-libraries/blob/master/src/org/stan/Utils.groovy#L51) ("UNSTABLE") to send a notification email.